@model TeamPermissionsViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = "Team Permissions: " + @Model.TeamName;
    int currentUserId = Convert.ToInt32(User.FindFirstValue(ClaimTypes.NameIdentifier));
    bool canManagePermissions = Model.CanManagePermissions;
    int count = 1;
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2>
                    <i class="bi bi-shield-check text-primary me-2"></i>
                    Team Permissions: @Model.TeamName
                </h2>
                <p class="text-muted">
                    <i class="bi bi-info-circle me-2"></i>
                    View @(canManagePermissions ? "and manage" : "") user permissions for this team
                </p>
            </div>
            <div>
                <a asp-action="Details" asp-route-id="@Model.TeamId" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Team
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-people"></i> Team Members & Permissions
                </h5>
            </div>
            <div class="card-body">
                @if (!Model.Users.Any())
                {
                    <div class="text-center py-4">
                        <i class="bi bi-people fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No members found</h5>
                        <p class="text-muted">This team doesn't have any members yet.</p>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="permissionsTable">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-hash"></i> </th>
                                    <th><i class="bi bi-person"></i> Name</th>
                                    <th><i class="bi bi-shield"></i> Role</th>
                                    <th class="text-center"><i class="bi bi-list-check"></i> Task Permissions</th>
                                    <th class="text-center"><i class="bi bi-folder"></i> Project Permissions</th>
                                    <th class="text-center"><i class="bi bi-people"></i> Team Management</th>
                                    @if (canManagePermissions)
                                    {
                                        <th class="text-center"><i class="bi bi-gear"></i> Actions</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in Model.Users.OrderByDescending(u => u.Role == "Manager").ThenBy(u => u.Name))
                                {
                                    <tr class="@(user.UserId == currentUserId ? "table-active" : "")">
                                        <td>@count</td>
                                        <td>
                                            <i class="bi bi-person @(user.UserId == currentUserId ? "text-success" : "text-info") me-2"></i>
                                            <strong>@user.Name</strong>
                                            @if (user.UserId == currentUserId)
                                            {
                                                <span class="badge bg-success ms-2">
                                                    <i class="bi bi-person-check me-1"></i> You
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-@(user.Role == "Manager" ? "danger" : user.IsSystemRole ? "primary" : "info")">
                                                <i class="bi bi-@(user.Role == "Manager" ? "shield" : "person-workspace") me-1"></i>
                                                @user.Role
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column gap-2">
                                                <small>
                                                    @if (user.CanViewTasks)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>View</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>View</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanEditTasks)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Edit</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Edit</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanDeleteTasks)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Delete</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Delete</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanAssignTasks)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Assign</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Assign</span>
                                                    }
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column gap-2">
                                                <small>
                                                    @if (user.CanViewProjects)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>View</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>View</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanEditProjects)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Edit</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Edit</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanDeleteProjects)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Delete</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Delete</span>
                                                    }
                                                </small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column gap-2">
                                                <small>
                                                    @if (user.CanInviteMembers)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Invite</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Invite</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanRemoveMembers)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Remove</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Remove</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanManageRoles)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Manage Roles</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Manage Roles</span>
                                                    }
                                                </small>
                                                <small>
                                                    @if (user.CanManagePermissions)
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Manage Permissions</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Manage Permissions</span>
                                                    }
                                                </small>
                                            </div>
                                        </td>
                                        @if (canManagePermissions)
                                        {
                                            <td class="text-center">
                                                @if (user.UserId != Model.ManagerId)
                                                {
                                                    <button type="button" class="btn btn-sm btn-warning btn-edit-permissions"
                                                            data-user-id="@user.UserId"
                                                            data-user-name="@user.Name"
                                                            data-role-id="@user.RoleId">
                                                        <i class="bi bi-pencil"></i> Edit
                                                    </button>
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">Cannot edit manager</span>
                                                }
                                            </td>
                                        }
                                    </tr>
                                    count++;
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-info-circle text-info me-2"></i>
                    Permission Information
                </h6>
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-primary"><i class="bi bi-list-check me-2"></i>Task Permissions</h6>
                        <ul class="mb-0 small">
                            <li><strong>View:</strong> See and read task information</li>
                            <li><strong>Edit:</strong> Create, modify, and update tasks</li>
                            <li><strong>Delete:</strong> Remove tasks from projects</li>
                            <li><strong>Assign:</strong> Assign tasks to team members</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary"><i class="bi bi-folder me-2"></i>Project Permissions</h6>
                        <ul class="mb-0 small">
                            <li><strong>View:</strong> See and read project information</li>
                            <li><strong>Edit:</strong> Create, modify, and update projects</li>
                            <li><strong>Delete:</strong> Remove projects from the team</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary"><i class="bi bi-people me-2"></i>Team Management</h6>
                        <ul class="mb-0 small">
                            <li><strong>Invite:</strong> Send invitations to new members</li>
                            <li><strong>Remove:</strong> Remove members from the team</li>
                            <li><strong>Manage Roles:</strong> Create, edit, and delete team roles</li>
                            <li><strong>Manage Permissions:</strong> Override user permissions</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Permissions Modal -->
<div class="modal fade" id="editUserPermissionsModal" tabindex="-1" aria-labelledby="editUserPermissionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editUserPermissionsForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserPermissionsModalLabel">
                        <i class="bi bi-shield-check"></i> Edit User Permissions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="TeamId" value="@Model.TeamId" />
                    <input type="hidden" name="UserId" id="editUserId" />

                    <div class="mb-3">
                        <label class="form-label"><strong>User:</strong> <span id="editUserName"></span></label>
                    </div>

                    <div class="mb-3">
                        <label for="editUserRoleId" class="form-label">Role</label>
                        <select class="form-select" id="editUserRoleId" name="RoleId">
                            <option value="">-- Keep current role --</option>
                        </select>
                        <small class="form-text text-muted">Select a role to change the user's role, or leave unchanged</small>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-list-check"></i> Permission Overrides</h6>
                            <small class="text-muted">Override specific permissions for this user. Leave unchecked to use role default.</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="text-primary">Task Permissions</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanViewTasks" data-permission="CanViewTasks">
                                        <label class="form-check-label" for="overrideCanViewTasks">View Tasks</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanViewTasksValue" name="CanViewTasks" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanEditTasks" data-permission="CanEditTasks">
                                        <label class="form-check-label" for="overrideCanEditTasks">Edit Tasks</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanEditTasksValue" name="CanEditTasks" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanDeleteTasks" data-permission="CanDeleteTasks">
                                        <label class="form-check-label" for="overrideCanDeleteTasks">Delete Tasks</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanDeleteTasksValue" name="CanDeleteTasks" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanAssignTasks" data-permission="CanAssignTasks">
                                        <label class="form-check-label" for="overrideCanAssignTasks">Assign Tasks</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanAssignTasksValue" name="CanAssignTasks" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-primary">Project Permissions</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanViewProjects" data-permission="CanViewProjects">
                                        <label class="form-check-label" for="overrideCanViewProjects">View Projects</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanViewProjectsValue" name="CanViewProjects" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanEditProjects" data-permission="CanEditProjects">
                                        <label class="form-check-label" for="overrideCanEditProjects">Edit Projects</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanEditProjectsValue" name="CanEditProjects" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanDeleteProjects" data-permission="CanDeleteProjects">
                                        <label class="form-check-label" for="overrideCanDeleteProjects">Delete Projects</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanDeleteProjectsValue" name="CanDeleteProjects" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-primary">Team Management</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanInviteMembers" data-permission="CanInviteMembers">
                                        <label class="form-check-label" for="overrideCanInviteMembers">Invite Members</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanInviteMembersValue" name="CanInviteMembers" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanRemoveMembers" data-permission="CanRemoveMembers">
                                        <label class="form-check-label" for="overrideCanRemoveMembers">Remove Members</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanRemoveMembersValue" name="CanRemoveMembers" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanManageRoles" data-permission="CanManageRoles">
                                        <label class="form-check-label" for="overrideCanManageRoles">Manage Roles</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanManageRolesValue" name="CanManageRoles" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input permission-override" type="checkbox" id="overrideCanManagePermissions" data-permission="CanManagePermissions">
                                        <label class="form-check-label" for="overrideCanManagePermissions">Manage Permissions</label>
                                        <select class="form-select form-select-sm mt-1" id="overrideCanManagePermissionsValue" name="CanManagePermissions" style="display: none;">
                                            <option value="">Use Role Default</option>
                                            <option value="true">Allow</option>
                                            <option value="false">Deny</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="effectivePermissionsPreview" class="card bg-light" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-eye"></i> Effective Permissions Preview</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="text-primary small">Task Permissions</h6>
                                    <div id="previewTaskPerms" class="small"></div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-primary small">Project Permissions</h6>
                                    <div id="previewProjectPerms" class="small"></div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-primary small">Team Management</h6>
                                    <div id="previewTeamPerms" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Update Permissions
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <input type="hidden" id="js-permissions-data"
           data-team-id="@Model.TeamId"
           data-url-update="@Url.Action("UpdateUserPermissions", "Teams")"
           data-url-roles="@Url.Action("GetRolesJson", "Teams")"
           data-url-user-permissions="@Url.Action("GetUserPermissions", "Teams")"
           data-column-targets="@(canManagePermissions ? "0, 3, 4, 5, 6" : "0, 3, 4, 5")" />
    <script>
        var availableRoles = [];
        var currentUserPermissions = null;
        var currentRolePermissions = {};
        var initialOverrides = {};
        var _dataEl = document.getElementById('js-permissions-data');
        var _teamId = parseInt(_dataEl.getAttribute('data-team-id'), 10);
        var _urlUpdateUserPermissions = _dataEl.getAttribute('data-url-update');
        var _urlGetRolesJson = _dataEl.getAttribute('data-url-roles');
        var _urlGetUserPermissions = _dataEl.getAttribute('data-url-user-permissions');
        var _columnTargets = _dataEl.getAttribute('data-column-targets').split(',').map(function (s) { return parseInt(s.trim(), 10); });

        $(document).ready(function () {
            $('#permissionsTable').DataTable({
                "order": [[2, "asc"], [1, "asc"]], // Sort by role (Manager first), then by name
                "pageLength": 25,
                "language": {
                    "search": "Search members:",
                    "lengthMenu": "Show _MENU_ members per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ members",
                    "infoEmpty": "Showing 0 to 0 of 0 members",
                    "infoFiltered": "(filtered from _MAX_ total members)"
                },
                "columnDefs": [
                    { "orderable": false, "targets": _columnTargets }
                ],
                "scrollX": true
            });

            // Load available roles for the team
            loadAvailableRoles();

            // Handle edit permissions button click
            $(document).on('click', '.btn-edit-permissions', function() {
                var userId = $(this).data('user-id');
                var userName = $(this).data('user-name');
                var roleId = $(this).data('role-id');

                $('#editUserId').val(userId);
                // Use .text() so user name is escaped and not interpreted as HTML (XSS safety)
                $('#editUserName').text(userName);

                // Reset form
                $('.permission-override').prop('checked', false);
                $('.permission-override').each(function() {
                    var selectId = '#' + $(this).attr('id') + 'Value';
                    $(selectId).hide().val('');
                });
                $('#effectivePermissionsPreview').hide();

                // Load roles if not already loaded, then load user permissions
                if (availableRoles.length === 0) {
                    loadAvailableRoles(function() {
                        loadUserPermissions(userId);
                        var modal = new bootstrap.Modal(document.getElementById('editUserPermissionsModal'));
                        modal.show();
                    });
                } else {
                    loadUserPermissions(userId);
                    var modal = new bootstrap.Modal(document.getElementById('editUserPermissionsModal'));
                    modal.show();
                }
            });

            // Handle permission override checkbox change
            $('.permission-override').on('change', function() {
                var selectId = '#' + $(this).attr('id') + 'Value';
                if ($(this).is(':checked')) {
                    $(selectId).show();
                    updateEffectivePermissions();
                } else {
                    $(selectId).hide().val('');
                    updateEffectivePermissions();
                }
            });

            // Handle permission override value change
            $('[id$="Value"]').on('change', function() {
                updateEffectivePermissions();
            });

            // Handle role change
            $('#editUserRoleId').on('change', function() {
                updateEffectivePermissions();
            });

            // Handle form submission
            $('#editUserPermissionsForm').on('submit', function(e) {
                e.preventDefault();
                var formData = {};
                formData.TeamId = _teamId;
                formData.UserId = $('#editUserId').val();

                var roleId = $('#editUserRoleId').val();
                if (roleId) {
                    formData.RoleId = parseInt(roleId);
                }

                // Add permission overrides
                // Get the selected role to access its default permissions
                var selectedRoleId = $('#editUserRoleId').val() || (currentUserPermissions ? currentUserPermissions.roleId : null);
                var selectedRole = null;
                if (selectedRoleId && availableRoles.length > 0) {
                    selectedRole = availableRoles.find(r => r.id == parseInt(selectedRoleId));
                }

                var permissionNames = ['CanViewTasks', 'CanEditTasks', 'CanDeleteTasks', 'CanAssignTasks',
                                       'CanViewProjects', 'CanEditProjects', 'CanDeleteProjects',
                                       'CanInviteMembers', 'CanRemoveMembers', 'CanManageRoles', 'CanManagePermissions'];

                permissionNames.forEach(function(permissionName) {
                    var checkboxId = '#override' + permissionName;
                    var selectId = checkboxId + 'Value';
                    var checkbox = $(checkboxId);
                    var select = $(selectId);

                    // Helper function to get role's default value for a permission
                    function getRoleDefaultValue(permName) {
                        if (selectedRole && selectedRole.permissions) {
                            var rolePerms = selectedRole.permissions;
                            // Handle both camelCase and PascalCase property names
                            return rolePerms[permName.charAt(0).toLowerCase() + permName.slice(1)] ||
                                   rolePerms[permName] ||
                                   false;
                        }
                        return false;
                    }

                    if (checkbox.is(':checked') && select.length > 0) {
                        // Checkbox is checked
                        var value = select.val();
                        if (value !== '') {
                            // Dropdown has a value (Allow/Deny) - send that value
                            formData[permissionName] = value === 'true';
                        } else {
                            // Dropdown is "Use Role Default" - send role's default value
                            formData[permissionName] = getRoleDefaultValue(permissionName);
                        }
                    } else if (initialOverrides[permissionName]) {
                        // Checkbox is unchecked BUT it had an override initially - send role's default value
                        formData[permissionName] = getRoleDefaultValue(permissionName);
                    }
                    // If checkbox is unchecked and never had an override, don't include it (no change needed)
                });

                var userId = $('#editUserId').val();

                $.ajax({
                    url: _urlUpdateUserPermissions + '?teamId=' + _teamId + '&userId=' + userId,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response && response.isSuccess) {
                            $('#editUserPermissionsModal').modal('hide');
                            location.reload();
                        } else {
                            var errorMsg = response?.errorMessage || response?.errors || 'Failed to update permissions';
                            alert('Error: ' + errorMsg);
                        }
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = 'An error occurred while updating permissions.';
                        if (xhr.responseJSON) {
                            errorMsg = xhr.responseJSON.errorMessage || xhr.responseJSON.errors || errorMsg;
                        } else if (xhr.responseText) {
                            try {
                                var errorResponse = JSON.parse(xhr.responseText);
                                errorMsg = errorResponse.errorMessage || errorResponse.errors || errorMsg;
                            } catch (e) {
                                errorMsg = xhr.responseText || errorMsg;
                            }
                        }
                        alert('Error: ' + errorMsg);
                    }
                });
            });

            // Reset modal when closed
            $('#editUserPermissionsModal').on('hidden.bs.modal', function () {
                $('#editUserPermissionsForm')[0].reset();
                $('.permission-override').prop('checked', false);
                $('[id$="Value"]').hide().val('');
                $('#effectivePermissionsPreview').hide();
                currentUserPermissions = null;
                initialOverrides = {}; // Reset initial overrides tracking
            });
        });

        function loadAvailableRoles(callback) {
            $.ajax({
                url: _urlGetRolesJson + '?id=' + _teamId,
                type: 'GET',
                success: function(response) {
                    if (response && response.isSuccess && response.data) {
                        availableRoles = response.data.map(function(role) {
                            return {
                                id: role.id,
                                roleName: role.roleName,
                                permissions: role.permissions
                            };
                        });

                        // Populate role dropdown
                        var roleSelect = $('#editUserRoleId');
                        roleSelect.find('option:not(:first)').remove();
                        availableRoles.forEach(function(role) {
                            // .text() escapes content to prevent XSS from API-supplied role names
                            roleSelect.append($('<option></option>')
                                .attr('value', role.id)
                                .text(role.roleName));
                        });

                        if (callback) callback();
                    }
                },
                error: function(xhr, status, error) {
                    var errorMsg = 'Failed to load roles.';
                    if (xhr.responseJSON) {
                        errorMsg = xhr.responseJSON.errorMessage || xhr.responseJSON.errors || errorMsg;
                    } else if (xhr.responseText) {
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            errorMsg = errorResponse.errorMessage || errorResponse.errors || errorMsg;
                        } catch (e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                    }
                    console.error('Failed to load roles:', errorMsg);
                    if (callback) callback();
                }
            });
        }

        function loadUserPermissions(userId) {
            $.ajax({
                url: _urlGetUserPermissions + '?teamId=' + _teamId + '&userId=' + userId,
                type: 'GET',
                success: function(response) {
                    if (response && response.isSuccess && response.data) {
                        currentUserPermissions = response.data;

                        // Set current role
                        $('#editUserRoleId').val(response.data.roleId);

                        // Set current role in dropdown
                        $('#editUserRoleId').val(response.data.roleId);

                        // Load current role permissions
                        if (availableRoles.length > 0) {
                            var currentRole = availableRoles.find(r => r.id == response.data.roleId);
                            if (currentRole) {
                                currentRolePermissions = currentRole.permissions;
                            }
                        }

                        // Track initial overrides and set permission overrides
                        initialOverrides = {};
                        if (response.data.hasViewTasksOverride) {
                            initialOverrides.CanViewTasks = true;
                            $('#overrideCanViewTasks').prop('checked', true);
                            $('#overrideCanViewTasksValue').show().val(response.data.canViewTasks ? 'true' : 'false');
                        }
                        if (response.data.hasEditTasksOverride) {
                            initialOverrides.CanEditTasks = true;
                            $('#overrideCanEditTasks').prop('checked', true);
                            $('#overrideCanEditTasksValue').show().val(response.data.canEditTasks ? 'true' : 'false');
                        }
                        if (response.data.hasDeleteTasksOverride) {
                            initialOverrides.CanDeleteTasks = true;
                            $('#overrideCanDeleteTasks').prop('checked', true);
                            $('#overrideCanDeleteTasksValue').show().val(response.data.canDeleteTasks ? 'true' : 'false');
                        }
                        if (response.data.hasAssignTasksOverride) {
                            initialOverrides.CanAssignTasks = true;
                            $('#overrideCanAssignTasks').prop('checked', true);
                            $('#overrideCanAssignTasksValue').show().val(response.data.canAssignTasks ? 'true' : 'false');
                        }
                        if (response.data.hasViewProjectsOverride) {
                            initialOverrides.CanViewProjects = true;
                            $('#overrideCanViewProjects').prop('checked', true);
                            $('#overrideCanViewProjectsValue').show().val(response.data.canViewProjects ? 'true' : 'false');
                        }
                        if (response.data.hasEditProjectsOverride) {
                            initialOverrides.CanEditProjects = true;
                            $('#overrideCanEditProjects').prop('checked', true);
                            $('#overrideCanEditProjectsValue').show().val(response.data.canEditProjects ? 'true' : 'false');
                        }
                        if (response.data.hasDeleteProjectsOverride) {
                            initialOverrides.CanDeleteProjects = true;
                            $('#overrideCanDeleteProjects').prop('checked', true);
                            $('#overrideCanDeleteProjectsValue').show().val(response.data.canDeleteProjects ? 'true' : 'false');
                        }
                        if (response.data.hasInviteMembersOverride) {
                            initialOverrides.CanInviteMembers = true;
                            $('#overrideCanInviteMembers').prop('checked', true);
                            $('#overrideCanInviteMembersValue').show().val(response.data.canInviteMembers ? 'true' : 'false');
                        }
                        if (response.data.hasRemoveMembersOverride) {
                            initialOverrides.CanRemoveMembers = true;
                            $('#overrideCanRemoveMembers').prop('checked', true);
                            $('#overrideCanRemoveMembersValue').show().val(response.data.canRemoveMembers ? 'true' : 'false');
                        }
                        if (response.data.hasManageRolesOverride) {
                            initialOverrides.CanManageRoles = true;
                            $('#overrideCanManageRoles').prop('checked', true);
                            $('#overrideCanManageRolesValue').show().val(response.data.canManageRoles ? 'true' : 'false');
                        }
                        if (response.data.hasManagePermissionsOverride) {
                            initialOverrides.CanManagePermissions = true;
                            $('#overrideCanManagePermissions').prop('checked', true);
                            $('#overrideCanManagePermissionsValue').show().val(response.data.canManagePermissions ? 'true' : 'false');
                        }

                        updateEffectivePermissions();
                    }
                },
                error: function(xhr, status, error) {
                    var errorMsg = 'Failed to load user permissions.';
                    if (xhr.responseJSON) {
                        errorMsg = xhr.responseJSON.errorMessage || xhr.responseJSON.errors || errorMsg;
                    } else if (xhr.responseText) {
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            errorMsg = errorResponse.errorMessage || errorResponse.errors || errorMsg;
                        } catch (e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                    }
                    alert('Error: ' + errorMsg);
                }
            });
        }

        function updateEffectivePermissions() {
            var selectedRoleId = $('#editUserRoleId').val() || (currentUserPermissions ? currentUserPermissions.roleId : null);
            if (!selectedRoleId || availableRoles.length === 0) {
                $('#effectivePermissionsPreview').hide();
                return;
            }

            var role = availableRoles.find(r => r.id == parseInt(selectedRoleId));
            if (!role || !role.permissions) {
                $('#effectivePermissionsPreview').hide();
                return;
            }

            var rolePerms = role.permissions;
            var effectivePerms = {
                canViewTasks: $('#overrideCanViewTasks').is(':checked') && $('#overrideCanViewTasksValue').val() !== ''
                    ? $('#overrideCanViewTasksValue').val() === 'true'
                    : rolePerms.canViewTasks || rolePerms.CanViewTasks,
                canEditTasks: $('#overrideCanEditTasks').is(':checked') && $('#overrideCanEditTasksValue').val() !== ''
                    ? $('#overrideCanEditTasksValue').val() === 'true'
                    : rolePerms.canEditTasks || rolePerms.CanEditTasks,
                canDeleteTasks: $('#overrideCanDeleteTasks').is(':checked') && $('#overrideCanDeleteTasksValue').val() !== ''
                    ? $('#overrideCanDeleteTasksValue').val() === 'true'
                    : rolePerms.canDeleteTasks || rolePerms.CanDeleteTasks,
                canAssignTasks: $('#overrideCanAssignTasks').is(':checked') && $('#overrideCanAssignTasksValue').val() !== ''
                    ? $('#overrideCanAssignTasksValue').val() === 'true'
                    : rolePerms.canAssignTasks || rolePerms.CanAssignTasks,
                canViewProjects: $('#overrideCanViewProjects').is(':checked') && $('#overrideCanViewProjectsValue').val() !== ''
                    ? $('#overrideCanViewProjectsValue').val() === 'true'
                    : rolePerms.canViewProjects || rolePerms.CanViewProjects,
                canEditProjects: $('#overrideCanEditProjects').is(':checked') && $('#overrideCanEditProjectsValue').val() !== ''
                    ? $('#overrideCanEditProjectsValue').val() === 'true'
                    : rolePerms.canEditProjects || rolePerms.CanEditProjects,
                canDeleteProjects: $('#overrideCanDeleteProjects').is(':checked') && $('#overrideCanDeleteProjectsValue').val() !== ''
                    ? $('#overrideCanDeleteProjectsValue').val() === 'true'
                    : rolePerms.canDeleteProjects || rolePerms.CanDeleteProjects,
                canInviteMembers: $('#overrideCanInviteMembers').is(':checked') && $('#overrideCanInviteMembersValue').val() !== ''
                    ? $('#overrideCanInviteMembersValue').val() === 'true'
                    : rolePerms.canInviteMembers || rolePerms.CanInviteMembers,
                canRemoveMembers: $('#overrideCanRemoveMembers').is(':checked') && $('#overrideCanRemoveMembersValue').val() !== ''
                    ? $('#overrideCanRemoveMembersValue').val() === 'true'
                    : rolePerms.canRemoveMembers || rolePerms.CanRemoveMembers,
                canManageRoles: $('#overrideCanManageRoles').is(':checked') && $('#overrideCanManageRolesValue').val() !== ''
                    ? $('#overrideCanManageRolesValue').val() === 'true'
                    : rolePerms.canManageRoles || rolePerms.CanManageRoles || false,
                canManagePermissions: $('#overrideCanManagePermissions').is(':checked') && $('#overrideCanManagePermissionsValue').val() !== ''
                    ? $('#overrideCanManagePermissionsValue').val() === 'true'
                    : rolePerms.canManagePermissions || rolePerms.CanManagePermissions || false
            };

            // Update preview
            var taskPerms = [];
            if (effectivePerms.canViewTasks) taskPerms.push('<div class="mb-1"><span class="badge bg-success">View</span></div>');
            if (effectivePerms.canEditTasks) taskPerms.push('<div class="mb-1"><span class="badge bg-success">Edit</span></div>');
            if (effectivePerms.canDeleteTasks) taskPerms.push('<div class="mb-1"><span class="badge bg-success">Delete</span></div>');
            if (effectivePerms.canAssignTasks) taskPerms.push('<div class="mb-1"><span class="badge bg-success">Assign</span></div>');
            $('#previewTaskPerms').html(taskPerms.length > 0 ? taskPerms.join('') : '<span class="text-muted">None</span>');

            var projectPerms = [];
            if (effectivePerms.canViewProjects) projectPerms.push('<div class="mb-1"><span class="badge bg-success">View</span></div>');
            if (effectivePerms.canEditProjects) projectPerms.push('<div class="mb-1"><span class="badge bg-success">Edit</span></div>');
            if (effectivePerms.canDeleteProjects) projectPerms.push('<div class="mb-1"><span class="badge bg-success">Delete</span></div>');
            $('#previewProjectPerms').html(projectPerms.length > 0 ? projectPerms.join('') : '<span class="text-muted">None</span>');

            var teamPerms = [];
            if (effectivePerms.canInviteMembers) teamPerms.push('<div class="mb-1"><span class="badge bg-success">Invite</span></div>');
            if (effectivePerms.canRemoveMembers) teamPerms.push('<div class="mb-1"><span class="badge bg-success">Remove</span></div>');
            if (effectivePerms.canManageRoles) teamPerms.push('<div class="mb-1"><span class="badge bg-success">Manage Roles</span></div>');
            if (effectivePerms.canManagePermissions) teamPerms.push('<div class="mb-1"><span class="badge bg-success">Manage Permissions</span></div>');
            $('#previewTeamPerms').html(teamPerms.length > 0 ? teamPerms.join('') : '<span class="text-muted">None</span>');

            $('#effectivePermissionsPreview').show();
        }

    </script>
}

<style>
    .table > :not(caption) > * > * {
        padding: 1rem 0.5rem;
    }

    .badge {
        font-size: 0.9em;
        padding: 0.5em 1em;
    }

    .table-active {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
</style>
